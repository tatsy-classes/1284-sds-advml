

<!DOCTYPE html>


<html lang="ja" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>2. 特徴量抽出 &#8212; 機械学習発展 (実践)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/custom.js"></script>
    <script src="../../_static/translations.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'contents/sec2/feature-extraction';</script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="3. 深層学習による物体認識" href="deep-learning.html" />
    <link rel="prev" title="1. データ可視化と次元圧縮" href="data-visualization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="ja"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">機械学習発展 (実践)</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">第1部 画像読み取り式数独ソルバの実装</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../sec1/setup-python.html">1. Python環境の設定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec1/numpy.html">2. NumPyの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec1/matplotlib.html">3. Matplotlibの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec1/pandas.html">4. Pandasの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec1/opencv.html">5. OpenCVの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec1/figure-detection.html">6. 図形の検出</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec1/scikit-learn.html">7. scikit-learnによる機械分類の基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec1/exercise-sudoku.html">8. 演習1 - 画像入力式数独ソルバーを作る</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">第2部 ひらがなOCRソフトと百人一首エージェントの実装</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="data-visualization.html">1. データ可視化と次元圧縮</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">2. 特徴量抽出</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep-learning.html">3. 深層学習による物体認識</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise-ogura.html">4. 演習2 - 百人一首エージェントを作る</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">第3部 強化学習の基礎とリバーシエージェントの実装</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../sec3/reinforcement-learning.html">1. 強化学習の基礎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec3/q-learning.html">2. Q学習</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec3/othello-agent.html">3. オセロAIの作成</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec3/deep-reinforcement-learning.html">4. 深層強化学習</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec3/exercise-othello.html">5. 演習3 - オセロエージェントを作る</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../appendix/notation.html">資料中の表記について</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/tatsy/1284-sds-ml-advanced/blob/master/./contents/sec2/feature-extraction.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/tatsy/1284-sds-ml-advanced" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="ソースリポジトリ"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/tatsy/1284-sds-ml-advanced/issues/new?title=Issue%20on%20page%20%2Fcontents/sec2/feature-extraction.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="問題を報告"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="このページをダウンロード">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/contents/sec2/feature-extraction.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="ソースファイルをダウンロード"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="PDFに印刷"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="全画面モード"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="検索" aria-label="検索" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>特徴量抽出</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> 目次 </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">2.1. データセットの前処理</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2.1.1. 分類用のデータ加工</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#svm">2.1.2. 実験: SVMによる分類</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">2.2. 主成分分析による次元圧縮</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">2.2.1. 輝度によるヒストグラム化</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#local-binary-pattern-lbp">2.3. Local Binary Pattern (LBP)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uniform-lbp">2.3.1. Uniform LBP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#histogram-of-oriented-gradient-hog">2.4. Histogram of Oriented Gradient (HOG)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bag-of-visual-words">2.5. Bag of Visual Words</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scale-invariant-feature-transform-sift">2.5.1. Scale-Invariant Feature Transform (SIFT)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">特徴点の抽出</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">特徴量の計算</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">2.5.2. 特徴量のクラスタリング</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gauss">2.5.3. Gauss混合モデルを用いた改良</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fisher">2.5.4. Fisherベクトルの利用</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Fisherベクトルの導出</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Fisherベクトルの意味</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Fisherベクトルを用いた画像分類</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">2.6. 手法の比較</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">2.7. 練習問題</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">2.8. 参考文献</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="sec-feature-extraction">
<span id="id1"></span><h1><span class="section-number">2. </span>特徴量抽出<a class="headerlink" href="#sec-feature-extraction" title="Permalink to this heading">#</a></h1>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">下準備のコード</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">myst_nb</span> <span class="kn">import</span> <span class="n">glue</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">sklearn.exceptions</span> <span class="kn">import</span> <span class="n">ConvergenceWarning</span>

<span class="c1"># 実験に用いるデータ数</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">30000</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;n_samples&quot;</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># SGDに用いるバッチサイズ</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>

<span class="c1"># 一部の警告を無視</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>

<span class="c1"># シードの固定</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">31415</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">31415</span><span class="p">)</span>

<span class="c1"># グラフの設定</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;colorblind&quot;</span><span class="p">)</span>

<span class="c1"># 結果を格納しておくDataFrame</span>
<span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;Method&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Accuracy&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Phase&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>さて、今回からは数字ではなく「ひらがな」のデータセットを用いて、より複雑な識別問題に取り組む。</p>
<p>データセットは国立国会図書館の<a class="reference external" href="https://lab.ndl.go.jp/">NDLラボ</a>が公開している文字画像データセットを使用する。</p>
<ul class="simple">
<li><p>文字画像データセット: <a class="github reference external" href="https://github.com/ndl-lab/hiragana_mojigazo">ndl-lab/hiragana_mojigazo</a></p></li>
</ul>
<p>実際のデータセットは、以下のURLにホストされているので、ここからダウンロードする。</p>
<p><strong>文字画像データセット(平仮名73文字版) (zip形式)</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="http://lab.ndl.go.jp/dataset/hiragana73.zip">http://lab.ndl.go.jp/dataset/hiragana73.zip</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">平仮名73文字データセットの準備</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://lab.ndl.go.jp/dataset/hiragana73.zip&quot;</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="c1"># HTTPリクエストを送ってデータサイズを取得</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">65535</span>

<span class="c1"># &quot;hiragana73&quot;フォルダが存在し、その中身が空でないことを確認</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./hiragana73&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;./hiragana73&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># 実際のファイルのダウンロード</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>

    <span class="c1"># ダウンロードが完了したらZIPを展開する</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h2><span class="section-number">2.1. </span>データセットの前処理<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h2>
<p>このデータセットは濁音、半濁音を含むひらがな73文字に対して、そのUnicode値のフォルダの中に、48×48の画像がPNG形式で保存されている。</p>
<p>各ひらがなのUnicode値を調べるには、<code class="docutils literal notranslate"><span class="pre">ord</span></code>関数を用いてUnicode値に変換した後に、それを<code class="docutils literal notranslate"><span class="pre">hex</span></code>関数を用いて16進数表記の文字列に変換すれば良い。</p>
<p>一例として「あ」であれば、以下のようにUnicode値を得ることができる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text_a</span> <span class="o">=</span> <span class="s2">&quot;あ&quot;</span>
<span class="n">hex_a</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">text_a</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hex_a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0x3042
</pre></div>
</div>
</div>
</div>
<p>逆に、あいうえお順で文字を取得したければ、「あ」に対応するUnicode値である<code class="docutils literal notranslate"><span class="pre">0x3042</span></code>からスタートして、1ずつ値を上げていきながら、その数字を<code class="docutils literal notranslate"><span class="pre">chr</span></code>関数を用いて文字に変換すれば良い。</p>
<p>なお、16進数の文字列を整数に直したいときには、<code class="docutils literal notranslate"><span class="pre">int(hex_a)</span></code>と単に文字列を渡すだけではダメで、第2引数に何進数の数字なのかを与えて <code class="docutils literal notranslate"><span class="pre">int(hex_a,</span> <span class="pre">16)</span></code> のようにする必要があることに注意すること。</p>
<p>上記のひらがなデータセットは「ゃ」や「っ」などの小文字を含まない73文字から構成されているが、「あ」から「ん」までは、小文字を含め82文字なので、これを列挙してみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">82</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hex_a</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>あぃいぅうぇえぉおかがきぎくぐけげこごさざしじすずせぜそぞただちぢっつづてでとどなにぬねのはばぱひびぴふぶぷへべぺほぼぽまみむめもゃやゅゆょよらりるれろゎわゐゑをん
</pre></div>
</div>
</div>
</div>
<p>ひらがなデータセットのフォルダ名は16進数を表わす<code class="docutils literal notranslate"><span class="pre">0x</span></code>の代わりに<code class="docutils literal notranslate"><span class="pre">U</span></code>が接頭辞になっているので、フォルダ名の<code class="docutils literal notranslate"><span class="pre">U</span></code>を<code class="docutils literal notranslate"><span class="pre">0x</span></code>に置換して、どの文字がデータセットに含まれているかをチェックしてみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># サブフォルダの数を調べる</span>
<span class="n">dirname</span> <span class="o">=</span> <span class="s2">&quot;hiragana73&quot;</span>
<span class="n">folders</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">{:d}</span><span class="s1"> folders in &quot;</span><span class="si">{:s}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">),</span> <span class="n">dirname</span><span class="p">))</span>

<span class="c1"># フォルダに対応する文字を列挙</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;0x&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 73 folders in &quot;hiragana73&quot;.
あいうえおかがきぎくぐけげこごさざしじすずせぜそぞただちぢつづてでとどなにぬねのはばぱひびぴふぶぷへべぺほぼぽまみむめもやゆよらりるれろわゐゑをん
</pre></div>
</div>
</div>
</div>
<p>さらに、各文字に何個ずつ画像が含まれているかもチェックしておこう。</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>

<span class="n">chars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;0x&quot;</span><span class="p">),</span> <span class="mi">16</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">]</span>
<span class="n">dir_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">]</span>
<span class="n">num_images</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dir_paths</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chars</span><span class="p">,</span> <span class="n">num_images</span><span class="p">)])</span>
<span class="n">sub_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="mi">10</span><span class="p">)]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sub_dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))]</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))]</span>


<span class="k">def</span> <span class="nf">custom_style</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;font-weight: bold;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">styles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">)</span>


<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">format_index</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">format_index</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">custom_style</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_4d48e_row0_col0, #T_4d48e_row0_col2, #T_4d48e_row0_col4, #T_4d48e_row0_col6, #T_4d48e_row0_col8, #T_4d48e_row0_col10, #T_4d48e_row0_col12, #T_4d48e_row0_col14, #T_4d48e_row1_col0, #T_4d48e_row1_col2, #T_4d48e_row1_col4, #T_4d48e_row1_col6, #T_4d48e_row1_col8, #T_4d48e_row1_col10, #T_4d48e_row1_col12, #T_4d48e_row1_col14, #T_4d48e_row2_col0, #T_4d48e_row2_col2, #T_4d48e_row2_col4, #T_4d48e_row2_col6, #T_4d48e_row2_col8, #T_4d48e_row2_col10, #T_4d48e_row2_col12, #T_4d48e_row2_col14, #T_4d48e_row3_col0, #T_4d48e_row3_col2, #T_4d48e_row3_col4, #T_4d48e_row3_col6, #T_4d48e_row3_col8, #T_4d48e_row3_col10, #T_4d48e_row3_col12, #T_4d48e_row3_col14, #T_4d48e_row4_col0, #T_4d48e_row4_col2, #T_4d48e_row4_col4, #T_4d48e_row4_col6, #T_4d48e_row4_col8, #T_4d48e_row4_col10, #T_4d48e_row4_col12, #T_4d48e_row4_col14, #T_4d48e_row5_col0, #T_4d48e_row5_col2, #T_4d48e_row5_col4, #T_4d48e_row5_col6, #T_4d48e_row5_col8, #T_4d48e_row5_col10, #T_4d48e_row5_col12, #T_4d48e_row5_col14, #T_4d48e_row6_col0, #T_4d48e_row6_col2, #T_4d48e_row6_col4, #T_4d48e_row6_col6, #T_4d48e_row6_col8, #T_4d48e_row6_col10, #T_4d48e_row6_col12, #T_4d48e_row6_col14, #T_4d48e_row7_col0, #T_4d48e_row7_col2, #T_4d48e_row7_col4, #T_4d48e_row7_col6, #T_4d48e_row7_col8, #T_4d48e_row7_col10, #T_4d48e_row7_col12, #T_4d48e_row7_col14, #T_4d48e_row8_col0, #T_4d48e_row8_col2, #T_4d48e_row8_col4, #T_4d48e_row8_col6, #T_4d48e_row8_col8, #T_4d48e_row8_col10, #T_4d48e_row8_col12, #T_4d48e_row8_col14, #T_4d48e_row9_col0, #T_4d48e_row9_col2, #T_4d48e_row9_col4, #T_4d48e_row9_col6, #T_4d48e_row9_col8, #T_4d48e_row9_col10, #T_4d48e_row9_col12, #T_4d48e_row9_col14 {
  font-weight: bold;
}
</style>
<table id="T_4d48e">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_4d48e_level0_col0" class="col_heading level0 col0" ></th>
      <th id="T_4d48e_level0_col1" class="col_heading level0 col1" ></th>
      <th id="T_4d48e_level0_col2" class="col_heading level0 col2" ></th>
      <th id="T_4d48e_level0_col3" class="col_heading level0 col3" ></th>
      <th id="T_4d48e_level0_col4" class="col_heading level0 col4" ></th>
      <th id="T_4d48e_level0_col5" class="col_heading level0 col5" ></th>
      <th id="T_4d48e_level0_col6" class="col_heading level0 col6" ></th>
      <th id="T_4d48e_level0_col7" class="col_heading level0 col7" ></th>
      <th id="T_4d48e_level0_col8" class="col_heading level0 col8" ></th>
      <th id="T_4d48e_level0_col9" class="col_heading level0 col9" ></th>
      <th id="T_4d48e_level0_col10" class="col_heading level0 col10" ></th>
      <th id="T_4d48e_level0_col11" class="col_heading level0 col11" ></th>
      <th id="T_4d48e_level0_col12" class="col_heading level0 col12" ></th>
      <th id="T_4d48e_level0_col13" class="col_heading level0 col13" ></th>
      <th id="T_4d48e_level0_col14" class="col_heading level0 col14" ></th>
      <th id="T_4d48e_level0_col15" class="col_heading level0 col15" ></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_4d48e_level0_row0" class="row_heading level0 row0" ></th>
      <td id="T_4d48e_row0_col0" class="data row0 col0" >あ</td>
      <td id="T_4d48e_row0_col1" class="data row0 col1" >1208</td>
      <td id="T_4d48e_row0_col2" class="data row0 col2" >ぐ</td>
      <td id="T_4d48e_row0_col3" class="data row0 col3" >1043</td>
      <td id="T_4d48e_row0_col4" class="data row0 col4" >ず</td>
      <td id="T_4d48e_row0_col5" class="data row0 col5" >1046</td>
      <td id="T_4d48e_row0_col6" class="data row0 col6" >づ</td>
      <td id="T_4d48e_row0_col7" class="data row0 col7" >1080</td>
      <td id="T_4d48e_row0_col8" class="data row0 col8" >は</td>
      <td id="T_4d48e_row0_col9" class="data row0 col9" >1247</td>
      <td id="T_4d48e_row0_col10" class="data row0 col10" >べ</td>
      <td id="T_4d48e_row0_col11" class="data row0 col11" >1109</td>
      <td id="T_4d48e_row0_col12" class="data row0 col12" >や</td>
      <td id="T_4d48e_row0_col13" class="data row0 col13" >1285</td>
      <td id="T_4d48e_row0_col14" class="data row0 col14" >ゑ</td>
      <td id="T_4d48e_row0_col15" class="data row0 col15" >1030</td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row1" class="row_heading level0 row1" ></th>
      <td id="T_4d48e_row1_col0" class="data row1 col0" >い</td>
      <td id="T_4d48e_row1_col1" class="data row1 col1" >1122</td>
      <td id="T_4d48e_row1_col2" class="data row1 col2" >け</td>
      <td id="T_4d48e_row1_col3" class="data row1 col3" >1155</td>
      <td id="T_4d48e_row1_col4" class="data row1 col4" >せ</td>
      <td id="T_4d48e_row1_col5" class="data row1 col5" >1165</td>
      <td id="T_4d48e_row1_col6" class="data row1 col6" >て</td>
      <td id="T_4d48e_row1_col7" class="data row1 col7" >1213</td>
      <td id="T_4d48e_row1_col8" class="data row1 col8" >ば</td>
      <td id="T_4d48e_row1_col9" class="data row1 col9" >1105</td>
      <td id="T_4d48e_row1_col10" class="data row1 col10" >ぺ</td>
      <td id="T_4d48e_row1_col11" class="data row1 col11" >268</td>
      <td id="T_4d48e_row1_col12" class="data row1 col12" >ゆ</td>
      <td id="T_4d48e_row1_col13" class="data row1 col13" >1282</td>
      <td id="T_4d48e_row1_col14" class="data row1 col14" >を</td>
      <td id="T_4d48e_row1_col15" class="data row1 col15" >1254</td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row2" class="row_heading level0 row2" ></th>
      <td id="T_4d48e_row2_col0" class="data row2 col0" >う</td>
      <td id="T_4d48e_row2_col1" class="data row2 col1" >1148</td>
      <td id="T_4d48e_row2_col2" class="data row2 col2" >げ</td>
      <td id="T_4d48e_row2_col3" class="data row2 col3" >1058</td>
      <td id="T_4d48e_row2_col4" class="data row2 col4" >ぜ</td>
      <td id="T_4d48e_row2_col5" class="data row2 col5" >1115</td>
      <td id="T_4d48e_row2_col6" class="data row2 col6" >で</td>
      <td id="T_4d48e_row2_col7" class="data row2 col7" >1178</td>
      <td id="T_4d48e_row2_col8" class="data row2 col8" >ぱ</td>
      <td id="T_4d48e_row2_col9" class="data row2 col9" >262</td>
      <td id="T_4d48e_row2_col10" class="data row2 col10" >ほ</td>
      <td id="T_4d48e_row2_col11" class="data row2 col11" >1115</td>
      <td id="T_4d48e_row2_col12" class="data row2 col12" >よ</td>
      <td id="T_4d48e_row2_col13" class="data row2 col13" >1166</td>
      <td id="T_4d48e_row2_col14" class="data row2 col14" >ん</td>
      <td id="T_4d48e_row2_col15" class="data row2 col15" >1285</td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row3" class="row_heading level0 row3" ></th>
      <td id="T_4d48e_row3_col0" class="data row3 col0" >え</td>
      <td id="T_4d48e_row3_col1" class="data row3 col1" >1077</td>
      <td id="T_4d48e_row3_col2" class="data row3 col2" >こ</td>
      <td id="T_4d48e_row3_col3" class="data row3 col3" >1115</td>
      <td id="T_4d48e_row3_col4" class="data row3 col4" >そ</td>
      <td id="T_4d48e_row3_col5" class="data row3 col5" >1285</td>
      <td id="T_4d48e_row3_col6" class="data row3 col6" >と</td>
      <td id="T_4d48e_row3_col7" class="data row3 col7" >1184</td>
      <td id="T_4d48e_row3_col8" class="data row3 col8" >ひ</td>
      <td id="T_4d48e_row3_col9" class="data row3 col9" >1074</td>
      <td id="T_4d48e_row3_col10" class="data row3 col10" >ぼ</td>
      <td id="T_4d48e_row3_col11" class="data row3 col11" >1044</td>
      <td id="T_4d48e_row3_col12" class="data row3 col12" >ら</td>
      <td id="T_4d48e_row3_col13" class="data row3 col13" >1114</td>
      <td id="T_4d48e_row3_col14" class="data row3 col14" ></td>
      <td id="T_4d48e_row3_col15" class="data row3 col15" ></td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row4" class="row_heading level0 row4" ></th>
      <td id="T_4d48e_row4_col0" class="data row4 col0" >お</td>
      <td id="T_4d48e_row4_col1" class="data row4 col1" >1283</td>
      <td id="T_4d48e_row4_col2" class="data row4 col2" >ご</td>
      <td id="T_4d48e_row4_col3" class="data row4 col3" >1078</td>
      <td id="T_4d48e_row4_col4" class="data row4 col4" >ぞ</td>
      <td id="T_4d48e_row4_col5" class="data row4 col5" >1066</td>
      <td id="T_4d48e_row4_col6" class="data row4 col6" >ど</td>
      <td id="T_4d48e_row4_col7" class="data row4 col7" >1134</td>
      <td id="T_4d48e_row4_col8" class="data row4 col8" >び</td>
      <td id="T_4d48e_row4_col9" class="data row4 col9" >1045</td>
      <td id="T_4d48e_row4_col10" class="data row4 col10" >ぽ</td>
      <td id="T_4d48e_row4_col11" class="data row4 col11" >261</td>
      <td id="T_4d48e_row4_col12" class="data row4 col12" >り</td>
      <td id="T_4d48e_row4_col13" class="data row4 col13" >1244</td>
      <td id="T_4d48e_row4_col14" class="data row4 col14" ></td>
      <td id="T_4d48e_row4_col15" class="data row4 col15" ></td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row5" class="row_heading level0 row5" ></th>
      <td id="T_4d48e_row5_col0" class="data row5 col0" >か</td>
      <td id="T_4d48e_row5_col1" class="data row5 col1" >1259</td>
      <td id="T_4d48e_row5_col2" class="data row5 col2" >さ</td>
      <td id="T_4d48e_row5_col3" class="data row5 col3" >1261</td>
      <td id="T_4d48e_row5_col4" class="data row5 col4" >た</td>
      <td id="T_4d48e_row5_col5" class="data row5 col5" >1285</td>
      <td id="T_4d48e_row5_col6" class="data row5 col6" >な</td>
      <td id="T_4d48e_row5_col7" class="data row5 col7" >1233</td>
      <td id="T_4d48e_row5_col8" class="data row5 col8" >ぴ</td>
      <td id="T_4d48e_row5_col9" class="data row5 col9" >126</td>
      <td id="T_4d48e_row5_col10" class="data row5 col10" >ま</td>
      <td id="T_4d48e_row5_col11" class="data row5 col11" >1285</td>
      <td id="T_4d48e_row5_col12" class="data row5 col12" >る</td>
      <td id="T_4d48e_row5_col13" class="data row5 col13" >1190</td>
      <td id="T_4d48e_row5_col14" class="data row5 col14" ></td>
      <td id="T_4d48e_row5_col15" class="data row5 col15" ></td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row6" class="row_heading level0 row6" ></th>
      <td id="T_4d48e_row6_col0" class="data row6 col0" >が</td>
      <td id="T_4d48e_row6_col1" class="data row6 col1" >1200</td>
      <td id="T_4d48e_row6_col2" class="data row6 col2" >ざ</td>
      <td id="T_4d48e_row6_col3" class="data row6 col3" >1070</td>
      <td id="T_4d48e_row6_col4" class="data row6 col4" >だ</td>
      <td id="T_4d48e_row6_col5" class="data row6 col5" >1116</td>
      <td id="T_4d48e_row6_col6" class="data row6 col6" >に</td>
      <td id="T_4d48e_row6_col7" class="data row6 col7" >1260</td>
      <td id="T_4d48e_row6_col8" class="data row6 col8" >ふ</td>
      <td id="T_4d48e_row6_col9" class="data row6 col9" >1285</td>
      <td id="T_4d48e_row6_col10" class="data row6 col10" >み</td>
      <td id="T_4d48e_row6_col11" class="data row6 col11" >1142</td>
      <td id="T_4d48e_row6_col12" class="data row6 col12" >れ</td>
      <td id="T_4d48e_row6_col13" class="data row6 col13" >1238</td>
      <td id="T_4d48e_row6_col14" class="data row6 col14" ></td>
      <td id="T_4d48e_row6_col15" class="data row6 col15" ></td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row7" class="row_heading level0 row7" ></th>
      <td id="T_4d48e_row7_col0" class="data row7 col0" >き</td>
      <td id="T_4d48e_row7_col1" class="data row7 col1" >1121</td>
      <td id="T_4d48e_row7_col2" class="data row7 col2" >し</td>
      <td id="T_4d48e_row7_col3" class="data row7 col3" >1285</td>
      <td id="T_4d48e_row7_col4" class="data row7 col4" >ち</td>
      <td id="T_4d48e_row7_col5" class="data row7 col5" >1052</td>
      <td id="T_4d48e_row7_col6" class="data row7 col6" >ぬ</td>
      <td id="T_4d48e_row7_col7" class="data row7 col7" >1093</td>
      <td id="T_4d48e_row7_col8" class="data row7 col8" >ぶ</td>
      <td id="T_4d48e_row7_col9" class="data row7 col9" >1149</td>
      <td id="T_4d48e_row7_col10" class="data row7 col10" >む</td>
      <td id="T_4d48e_row7_col11" class="data row7 col11" >1058</td>
      <td id="T_4d48e_row7_col12" class="data row7 col12" >ろ</td>
      <td id="T_4d48e_row7_col13" class="data row7 col13" >1069</td>
      <td id="T_4d48e_row7_col14" class="data row7 col14" ></td>
      <td id="T_4d48e_row7_col15" class="data row7 col15" ></td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row8" class="row_heading level0 row8" ></th>
      <td id="T_4d48e_row8_col0" class="data row8 col0" >ぎ</td>
      <td id="T_4d48e_row8_col1" class="data row8 col1" >1091</td>
      <td id="T_4d48e_row8_col2" class="data row8 col2" >じ</td>
      <td id="T_4d48e_row8_col3" class="data row8 col3" >1099</td>
      <td id="T_4d48e_row8_col4" class="data row8 col4" >ぢ</td>
      <td id="T_4d48e_row8_col5" class="data row8 col5" >1132</td>
      <td id="T_4d48e_row8_col6" class="data row8 col6" >ね</td>
      <td id="T_4d48e_row8_col7" class="data row8 col7" >1126</td>
      <td id="T_4d48e_row8_col8" class="data row8 col8" >ぷ</td>
      <td id="T_4d48e_row8_col9" class="data row8 col9" >112</td>
      <td id="T_4d48e_row8_col10" class="data row8 col10" >め</td>
      <td id="T_4d48e_row8_col11" class="data row8 col11" >1233</td>
      <td id="T_4d48e_row8_col12" class="data row8 col12" >わ</td>
      <td id="T_4d48e_row8_col13" class="data row8 col13" >1283</td>
      <td id="T_4d48e_row8_col14" class="data row8 col14" ></td>
      <td id="T_4d48e_row8_col15" class="data row8 col15" ></td>
    </tr>
    <tr>
      <th id="T_4d48e_level0_row9" class="row_heading level0 row9" ></th>
      <td id="T_4d48e_row9_col0" class="data row9 col0" >く</td>
      <td id="T_4d48e_row9_col1" class="data row9 col1" >1266</td>
      <td id="T_4d48e_row9_col2" class="data row9 col2" >す</td>
      <td id="T_4d48e_row9_col3" class="data row9 col3" >1282</td>
      <td id="T_4d48e_row9_col4" class="data row9 col4" >つ</td>
      <td id="T_4d48e_row9_col5" class="data row9 col5" >1142</td>
      <td id="T_4d48e_row9_col6" class="data row9 col6" >の</td>
      <td id="T_4d48e_row9_col7" class="data row9 col7" >1160</td>
      <td id="T_4d48e_row9_col8" class="data row9 col8" >へ</td>
      <td id="T_4d48e_row9_col9" class="data row9 col9" >1114</td>
      <td id="T_4d48e_row9_col10" class="data row9 col10" >も</td>
      <td id="T_4d48e_row9_col11" class="data row9 col11" >1187</td>
      <td id="T_4d48e_row9_col12" class="data row9 col12" >ゐ</td>
      <td id="T_4d48e_row9_col13" class="data row9 col13" >1053</td>
      <td id="T_4d48e_row9_col14" class="data row9 col14" ></td>
      <td id="T_4d48e_row9_col15" class="data row9 col15" ></td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>このように、ひらがなについて、おおよそ1000程度の画像が含まれていることが確認できる。なお、半濁音のひらがなは全体的に少なめで100-200程度となっている。</p>
<section id="id3">
<h3><span class="section-number">2.1.1. </span>分類用のデータ加工<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<p>MNISTでは手書き文字の画像が28x28=576次元ベクトル、ラベルが10種類の数字のいずれかを表わす0-9の数字であった。</p>
<p>このようなデータ形式をひらがなデータセットに対しても作成しておく。なお、今回は分類の難易度を上げるため、<strong>画像をランダムに回転したり、拡大縮小したりして、データのばらつきを大きくしておく</strong>。また、今回のデータセットは画像が一度JPEGで圧縮されているようで、ブロックノイズを多く含むため、最初にバイラテラル・フィルタを書けてノイズを低減しておく。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 文字への整数の割り当て</span>
<span class="n">n_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
<span class="n">char2num</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chars</span><span class="p">)}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">n_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">num_images</span><span class="p">)</span>
<span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_total</span><span class="p">)</span>

<span class="c1"># 画像の読み取り</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 画像データ</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ラベルデータ</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dir_paths</span><span class="p">:</span>
    <span class="c1"># 文字に対する数字を計算</span>
    <span class="n">char</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;0x&quot;</span><span class="p">)</span>
    <span class="n">char</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">char2num</span><span class="p">[</span><span class="n">char</span><span class="p">]</span>
    <span class="c1"># 画像の読み込み</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Failed to load image: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

        <span class="c1"># ランダム輝度変更</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="p">(((</span><span class="n">image</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">)</span> <span class="o">**</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="mf">255.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>

        <span class="c1"># データのランダム回転、ランダムスケール</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">borderMode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_REPLICATE</span><span class="p">)</span>

        <span class="c1"># 細かなノイズの除去</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bilateralFilter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>

        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "49f9e86bcb3b4a31bc2cfa00daba2f6a", "version_major": 2, "version_minor": 0}</script></div>
</details>
</div>
<p>読み込みが完了したら例のごとく訓練データとテストデータに分割しておく。今回は画像が80000枚あるが、実験時間を短くするため、<span class="output text_plain">30000</span>枚を訓練画像、10000枚を検証用データ (今回は使わない)、10000枚をテスト画像とする。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">model_selection</span>

<span class="n">X</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mi">70000</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">X</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>データセットの先頭数枚の画像は次のようになっている。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/38ccf2bba2c7849b9d13a20f2fecf282a8b3ef7008ac237688530e0c6271c57c.png" src="../../_images/38ccf2bba2c7849b9d13a20f2fecf282a8b3ef7008ac237688530e0c6271c57c.png" />
</div>
</div>
</section>
<section id="svm">
<h3><span class="section-number">2.1.2. </span>実験: SVMによる分類<a class="headerlink" href="#svm" title="Permalink to this heading">#</a></h3>
<p>まずは、MNISTの時と同様にscikit-learnによる分類を試してみる。この時、<a class="reference internal" href="../sec1/scikit-learn.html#sec-scikit-learn"><span class="std std-ref">scikit-learnの節</span></a>で紹介したように、予め入力データを正規化しておく処理である<code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code>を使用する。</p>
<p>また、scikit-learnには<code class="docutils literal notranslate"><span class="pre">make_pipeline</span></code>というメソッドがあり、これを利用することで、「データの正規化」+「分類器の学習」を連続で行ってくれる仕組みも存在する。</p>
<p>ただし、今回は、サポートベクトルマシンの学習が低速である問題を解決するために、<code class="docutils literal notranslate"><span class="pre">SGDClassifier</span></code>というクラスに用意された<code class="docutils literal notranslate"><span class="pre">pertial_fit</span></code>というメソッドを使って、データセットの一部だけを分類器のパラメータ更新に用いる<strong>確率的最急降下法</strong> (SGD=Stochastic Gradienct Descent)により学習を行う。</p>
<p><code class="docutils literal notranslate"><span class="pre">partial_fit</span></code>メソッドは、<code class="docutils literal notranslate"><span class="pre">make_pipeline</span></code>には対応していないため、自前で<code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code>によるデータの正規化と<code class="docutils literal notranslate"><span class="pre">partial_fit</span></code>によるパラメータ更新を連続で行うクラスを用意する。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">StandardScaler+SGDClassifierの実行クラス</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">SGDClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>


<span class="k">class</span> <span class="nc">MySGDClassifier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">SGDClassifier</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># 前処理の学習</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># バッチを用いたトレーニング</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">rand_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">rand_idx</span><span class="p">[</span><span class="n">b</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">rand_idx</span><span class="p">[</span><span class="n">b</span> <span class="p">:</span> <span class="n">b</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>

            <span class="n">X_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X_norm</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_norm</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;score=</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_norm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">X_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_norm</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>なお、<code class="docutils literal notranslate"><span class="pre">SGDClassier</span></code>は、 <code class="docutils literal notranslate"><span class="pre">loss=&quot;hinge&quot;</span></code> とすることで、内部の分類器が線形SVMになる。また、<code class="docutils literal notranslate"><span class="pre">partial_fit</span></code>で分類器のパラメータ更新を行う際は、<code class="docutils literal notranslate"><span class="pre">learning_rate=...</span></code>ならびに更新率を<code class="docutils literal notranslate"><span class="pre">eta0=...</span></code>の設定で学習の進行度が変化する。以下のコードでは<code class="docutils literal notranslate"><span class="pre">learning_rate=&quot;optimal&quot;</span></code>を指定して、適当な学習率を自動で与えている。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sgd_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="s2">&quot;hinge&quot;</span><span class="p">,</span>
    <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="s2">&quot;optimal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;penalty&quot;</span><span class="p">:</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">1.0e-2</span><span class="p">,</span>
    <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;max_iter&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="s2">&quot;n_jobs&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">clf</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6d3adafb69324c81bcb7c8a05913b1aa", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;naive_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Image&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テストデータに対する識別精度の計算</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;naive_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Image&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: 画像をそのまま入力</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">51.30</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">48.29</span>%</p></li>
</ul>
<p>このように、今回は分類問題の難易度が上がっており、SVMを用いても十分な精度が得られていないことが分かる。また、単に画像をベクトルとして扱うのは、(特に入力画像が大きい場合には)計算効率の観点からも好ましいとは言いがたい。加えて、必ずしもデータセット中の画像の大きさが揃っていることばかりではないので、画像の大きさに依存しないように画像を特徴ベクトル化できることが好ましいと言える。</p>
</section>
</section>
<section id="id4">
<h2><span class="section-number">2.2. </span>主成分分析による次元圧縮<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h2>
<p>まずは、前項の<a class="reference internal" href="data-visualization.html#sec-data-visualization"><span class="std std-ref">次元圧縮</span></a>を参考に、主成分分析を用いて、画像データを低次元ベクトルに変換し、それを学習に用いる方策を考えてみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf0</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf0</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_pca</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ef205dadf1c6458690b03f46554b8999", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf0</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_pca</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;pca_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テストデータに対する識別精度の計算</span>
<span class="n">X_pca_test</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf0</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_pca_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;pca_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: 主成分分析による次元圧縮</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">30.09</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">28.68</span>%</p></li>
</ul>
<section id="id5">
<h3><span class="section-number">2.2.1. </span>輝度によるヒストグラム化<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h3>
<p>まず、非常に単純なアイディアとして画像の輝度を基準としたヒストグラム化を考えてみる。今、画像は256階調の輝度で表わされているので、輝度のヒストグラムを作ることで、どれほど大きな画像であっても256次元のベクトルにすることができる。</p>
<p>一例として、データセットの先頭の画像に対して、輝度ヒストグラムを計算した結果が以下である (分かりやすさのためにヒストグラムのbin数を32としてある)。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Input image&quot;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Histogram of image intensities&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/98dda50caa796bfa7a7966f7c6678ecf69246b4445e9aff191e2399d073f5e03.png" src="../../_images/98dda50caa796bfa7a7966f7c6678ecf69246b4445e9aff191e2399d073f5e03.png" />
</div>
</div>
<p>このヒストグラムを画像全体に対する特徴ベクトルとみなし、SVMによる文字分類を試してみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">X_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">X_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "080ab58555914d25a468fc444ad6a602", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf2</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_hist</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bdcef0632a2c4def82021ebe8b5ace50", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf2</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_hist</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;hist_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Hist&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hist_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X_test</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">X_hist_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">X_hist_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_hist_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "dfc61dccf95049dfb8b53448a39a81f5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テストデータに対する識別精度の計算</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf2</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_hist_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;hist_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Hist&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: 輝度ヒストグラムの利用</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">3.34</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">2.58</span>%</p></li>
</ul>
<p>しかし、実際に試してみると上記のように満足な精度が得られるには至っていない。これは、ほとんどの画像がほぼ同じ割合の白と黒の領域でできていて、それをヒストグラム化してしまうと、文字の分類が難しくなるためである。</p>
<p>また、輝度のヒストグラムは写真を写した時の周囲の明るさなどにも影響を受けるため、たとえ写真に写っている物が同じであったとしても、周囲の環境によって、ヒストグラムが変化してしまうなど、一貫性に乏しい。</p>
<p>従って、もう少し気の利いた方法を考える必要がある。</p>
</section>
</section>
<section id="local-binary-pattern-lbp">
<h2><span class="section-number">2.3. </span>Local Binary Pattern (LBP)<a class="headerlink" href="#local-binary-pattern-lbp" title="Permalink to this heading">#</a></h2>
<p>Local Binary Pattern (LBP)は、とある画素を中心とした3x3の領域について、中心画素と周りの画素の輝度の大小を数値化する手法である <span id="id6">[<a class="reference internal" href="#id27" title="Timo Ojala, Matti Pietikäinen, and David Harwood. A comparative study of texture measures with classification based on featured distributions. Pattern recognition, 29(1):51–59, 1996. doi:10.1016/0031-3203(95)00067-4.">Ojala <em>et al.</em>, 1996</a>]</span>。</p>
<p>一例として、とある中心画素周辺の画素値が以下のようになっている場合を考えよう。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">draw_frame</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">problem</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ims</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">frame</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ims</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">problem</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">draw_frame</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8ef4846a3d4bb2f4aa854e0d47e410354c2dad09192c36bc3fa25d244a3e8d82.png" src="../../_images/8ef4846a3d4bb2f4aa854e0d47e410354c2dad09192c36bc3fa25d244a3e8d82.png" />
</div>
</div>
<p>このとき、中心画素と周囲の8画素の大小を見比べて、大きいものを1, 小さいものを0に置き換える。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">draw_frame</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/27e17fc1c989ef82a0b0df652d4c79d13e9f44f859924d0858985c7c985e0f87.png" src="../../_images/27e17fc1c989ef82a0b0df652d4c79d13e9f44f859924d0858985c7c985e0f87.png" />
</div>
</div>
<p>この周囲の8画素に割り当てられた0, 1のパターンが8ビットの符号なし整数であると考えて数値を求める。このとき、以下のような時計回りに2のべき乗が並んだ画像を用いると良い。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">draw_frame</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f2236b3f32fa1673cc93a1ca9b2154c64f9e9df23009dbdfa0a94d2de2e3c2d5.png" src="../../_images/f2236b3f32fa1673cc93a1ca9b2154c64f9e9df23009dbdfa0a94d2de2e3c2d5.png" />
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<p>すると、上記の3x3の領域に対しては、LBPの値として**<span class="output text_plain">123</span>**が求まる。</p>
<p>この計算を先ほどと同様にデータセットの先頭画像の各画素に対して計算すると、その結果と、LBP値のヒストグラムは以下のようになる。</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>

<span class="n">lbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
        <span class="n">lbp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># 輪郭の画素では計算できないので、輪郭を除いておく</span>
<span class="n">lbp</span> <span class="o">=</span> <span class="n">lbp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lbp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;LBP image&quot;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">lbp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of LBP values&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/530b109020e8215ee0336a457547ea4da4f5c746ac59dc25e8c9bc6b3703b6a8.png" src="../../_images/530b109020e8215ee0336a457547ea4da4f5c746ac59dc25e8c9bc6b3703b6a8.png" />
</div>
</div>
<p>LBPを用いることの利点は画像の相対的な輝度だけを見ている点にあり、仮に画像の輝度が2倍になったりしても求まるLBPの値は全く変化しない。そのため、同じ対象を異なる光源下で計算した場合などに一貫した特徴を得られる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.feature_extraction.image</span> <span class="kn">import</span> <span class="n">extract_patches_2d</span>


<span class="k">def</span> <span class="nf">calc_lbp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>

    <span class="n">patches</span> <span class="o">=</span> <span class="n">extract_patches_2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">patches</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">binary</span> <span class="o">=</span> <span class="p">(</span><span class="n">patches</span> <span class="o">&gt;</span> <span class="n">centers</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">binary</span> <span class="o">*</span> <span class="n">pat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">calc_lbp_hist</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">lbp</span> <span class="o">=</span> <span class="n">calc_lbp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">lbp</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<span class="n">X_lbp</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_lbp_hist</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X</span><span class="p">)]</span>
<span class="n">X_lbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_lbp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1d99e06b514746cabd6c7fcb11e8d364", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf3</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_lbp</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "66aac24777844665be2a8c26a491dedd", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf3</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_lbp</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;lbp_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LBP&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_lbp_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_lbp_hist</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X_test</span><span class="p">)]</span>
<span class="n">X_lbp_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_lbp_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8f9d9a9b13454f49ab561cecdf789962", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テストデータに対する識別精度の計算</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf3</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_lbp_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;lbp_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LBP&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: Local Binary Patternの利用</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">10.73</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">9.02</span>%</p></li>
</ul>
<p>先ほどの単純な輝度ヒストグラムに比べれば、精度は改善しているものの、画像をそのまま入力したSVMには劣る結果となっている。</p>
<p>今、データセットに含まれるデータはひらがながランダムに回転したりスケールしたりしている。LBPは上記の計算方法からも分かるとおり、物体が回転してしまうと得られる値が変わってしまう性質がある。従って、今回のようにデータセット中でひらがながランダムに回転しているような場合には、もう少し工夫をする必要がある。</p>
<section id="uniform-lbp">
<h3><span class="section-number">2.3.1. </span>Uniform LBP<a class="headerlink" href="#uniform-lbp" title="Permalink to this heading">#</a></h3>
<p>元々のLBPが持つ回転に対して変化してしまう問題を解決した手法の一つに<strong>Uniform LBP</strong> <span id="id7">[<a class="reference internal" href="#id30" title="Timo Ojala, Matti Pietikäinen, and Topi Maenpaa. Multiresolution gray-scale and rotation invariant texture classification with local binary patterns. IEEE Transactions on pattern analysis and machine intelligence, 24(7):971–987, 2002. doi:10.1109/tpami.2002.1017623.">Ojala <em>et al.</em>, 2002</a>]</span> がある。</p>
<p>Uniform LBPの基本的なアイディアは、注目画素を中心に<strong>円状に配置された点の輝度</strong>を調べて、その輝度の大小関係のパターン (つまり, 0, 1の列)が回転したときに一致するものを同じ物であると見なすという部分にある。</p>
<p>より具体的には、円状に配置された0, 1の列を1周する間に何回0から1あるいは1から0への変化が起こるかを考える。例えば、12時方向を視点として反時計回りに <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">0,</span> <span class="pre">1,</span> <span class="pre">0,</span> <span class="pre">1,</span> <span class="pre">1,</span> <span class="pre">1,</span> <span class="pre">0)</span></code> というパターンが現れたとすると、0→1 / 1→0の遷移回数は4回である。</p>
<p>Uniform LBPでは、この遷移回数が0回のものと2回のものを特別視する。遷移の回数が0回、ということは、全ての要素が0か1かのいずれかで2通りが考えられる。また、遷移の回数が2回、ということは、0と1が両方含まれているものの、0と1が連続して現れているようなパターンで、これは要素の数が<span class="math notranslate nohighlight">\(N\)</span>個であれば、<span class="math notranslate nohighlight">\(N-1\)</span>通りのパターンが考えられる。</p>
<p>以上より、遷移の回数が0回のものと2回のものの総数は<span class="math notranslate nohighlight">\(N+1\)</span>個ある。これ以外のパターンは全て同じものであると見なすと、パターンの総数は<span class="math notranslate nohighlight">\(N+2\)</span>個である。</p>
<p>以下ではscikit-imageの<code class="docutils literal notranslate"><span class="pre">local_binary_pattern</span></code>を用いて、<span class="math notranslate nohighlight">\(N=36\)</span>とした場合のLBP画像を見てみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">local_binary_pattern</span>

<span class="n">n_angles</span> <span class="o">=</span> <span class="mi">36</span>
<span class="n">lbp</span> <span class="o">=</span> <span class="n">local_binary_pattern</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)),</span> <span class="n">n_angles</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lbp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">{:d}</span><span class="s2"> values&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lbp</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">lbp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">n_angles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of Uniform LBP&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/7f090121600570b11ba59ed1f2683651cdffab2c5bd4a0728d3b5732490cc5c5.png" src="../../_images/7f090121600570b11ba59ed1f2683651cdffab2c5bd4a0728d3b5732490cc5c5.png" />
</div>
</div>
<p>すると、上記の通り、輝度のパターン数は36 + 2 = 38通りになることが分かる (画像の輝度が0から37の38通りになっている)。</p>
<p>また、画像の見た目から、文字がある部分の周りが一様に近いグレーで表現されており、回転に対してある程度の不変性を持っていそうなことも確認できる。</p>
<p>では、このUniform LBPを用いて、再度SVMによる文字の分類を試してみる。Uniform LBPを使う場合、画像の拡大縮小への対応力を上げるために、<strong>中心画素からどのくらい離れたところの画素をLBPの計算に使うか</strong>を変えつつ、LBPを取得して、それらを結合した特徴量を使う。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_ulbp_hist</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">n_angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
    <span class="n">hists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_angles</span><span class="p">)):</span>
        <span class="n">lbp</span> <span class="o">=</span> <span class="n">local_binary_pattern</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_angles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">lbp</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">n_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">hists</span><span class="p">)</span>


<span class="n">X_ulbp</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_ulbp_hist</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X</span><span class="p">)]</span>
<span class="n">X_ulbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_ulbp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0c3ae4114f084cb6bc7a95d29af6d484", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf4</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf4</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_ulbp</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e0ece29f595349f3911abbcab7ce2f55", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf4</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_ulbp</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;ulbp_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Uniform LBP&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_ulbp_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_ulbp_hist</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X_test</span><span class="p">)]</span>
<span class="n">X_ulbp_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_ulbp_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5e6fc2a0996b422d8039a30380833d41", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テストデータに対する識別精度の計算</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf4</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_ulbp_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;ulbp_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Uniform LBP&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: 輝度ヒストグラムの利用</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">7.88</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">7.35</span>%</p></li>
</ul>
<p>すると、今度は訓練のスコアが悪化した代わりにテストスコアが上昇していることが分かる。しかしながら、これでも識別精度としては十分ではなく、回転対称性を考慮したことで精度が改善したとは言いがたい。</p>
</section>
</section>
<section id="histogram-of-oriented-gradient-hog">
<h2><span class="section-number">2.4. </span>Histogram of Oriented Gradient (HOG)<a class="headerlink" href="#histogram-of-oriented-gradient-hog" title="Permalink to this heading">#</a></h2>
<p>Histogram of Oriented Gradient (HOG)が広く知られるようになったのは2005年のことで、コンピュータ・ビジョンの国際会議であるCVPRで発表された論文<span id="id8">[<a class="reference internal" href="#id31" title="N. Dalal and B. Triggs. Histograms of oriented gradients for human detection. In 2005 IEEE Computer Society Conference on Computer Vision and Pattern Recognition (CVPR\textquotesingle 05), volume 1, 886–893. IEEE, IEEE, 2005. doi:10.1109/cvpr.2005.177.">Dalal and Triggs, 2005</a>]</span>がきっかけとなっている。</p>
<p>特にHOGは人物の全身といった特定の物体を見つける性能に優れており、一般物体認識や物体追跡等の多数の応用が生まれた。</p>
<p>HOGは画像を、互いに重ならない小さなパッチに分割して計算を行う。今回用いるひらがな画像は48×48の大きさなので、これを8×8のパッチに区切ってみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">im</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
<span class="n">s</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">s</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">patches</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/7cf8081983349343433cabce314fa0e766a3e89e26a5e4a84a49f5d7de8d1c3d.png" src="../../_images/7cf8081983349343433cabce314fa0e766a3e89e26a5e4a84a49f5d7de8d1c3d.png" />
</div>
</div>
<p>次に、この各画像に対して、勾配強度と勾配方向を画素ごとに計算する。以下の実装では、x方向の勾配<span class="math notranslate nohighlight">\(d_x\)</span>とy方向の勾配<span class="math notranslate nohighlight">\(d_y\)</span>をSobelフィルタを使って求め、勾配強度<span class="math notranslate nohighlight">\(g\)</span>と勾配方向<span class="math notranslate nohighlight">\(\theta\)</span>を以下のように定義する。</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
    g &amp;= \sqrt{ d_x^2 + d_y^2 } \\
    \theta &amp;= \text{arctan} \frac{|d_y|}{d_x}
\end{align}
\end{split}\]</div>
<p>なお、今回は向きのない方向 (= orientation, 0°から180°)を求めるため、上記の<span class="math notranslate nohighlight">\(\theta\)</span>の式において<span class="math notranslate nohighlight">\(d_y\)</span>に絶対値がかかっていることに注意すること。</p>
<p>今、各パッチは8×8の大きさなので、勾配強度と勾配方向がそれぞれ64個ずつ求まる。求まった勾配方向をいくつかの方向に量子化 (今回は20°刻みで9方向)し、ヒストグラムを作成する。各画素の方向に対応するビンには勾配強度を足して、ヒストグラムを計算する。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_hist</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n_angles</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_8U</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_8U</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">dx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span> <span class="n">dy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">),</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="n">n_angles</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_angles</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">g_</span><span class="p">,</span> <span class="n">t_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
        <span class="n">h</span><span class="p">[</span><span class="n">t_</span><span class="p">]</span> <span class="o">+=</span> <span class="n">g_</span>

    <span class="k">return</span> <span class="n">h</span>


<span class="n">n_angles</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">hists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">calc_hist</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n_angles</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> histograms with </span><span class="si">{</span><span class="n">hists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> bins are obtained!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>36 histograms with 9 bins are obtained!
</pre></div>
</div>
</div>
</div>
<p>これにより6×6=36個のヒストグラムが求まった。ここで注意したいのは、これらのヒストグラムは勾配強度で計算されており、場所によって、ヒストグラムのスケールが異なっているという点である。</p>
<p>そこで、HOGでは、この6×6個のパッチを3×3のブロックごとに走査し、そのブロック内で連結したヒストグラムを正規化して用いる。今、勾配方向は9つに離散化されており、ブロック内のパッチが3×3=9個なので、1ブロックが持つヒストグラムの次元は9×9=81次元である。この81次元ベクトルをノルムが1になるように正規化しておく。</p>
<p>最終的に、81次元のヒストグラムが複数 (今回の場合は(6-3+1)×(6-3+1)=16個)求まるので、これらを連結して、画像の特徴量として用いる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">hists</span> <span class="o">=</span> <span class="n">hists</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># ブロックの取り出し</span>
<span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="n">hists</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">bs</span><span class="p">,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">bs</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">bs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">bs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">hog</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_angles</span> <span class="o">*</span> <span class="n">bs</span> <span class="o">*</span> <span class="n">bs</span><span class="p">))</span>

<span class="c1"># ブロックごとのヒストグラムのノルムが1となるように正規化</span>
<span class="n">hog</span> <span class="o">=</span> <span class="n">hog</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hog</span> <span class="o">*</span> <span class="n">hog</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">hog</span> <span class="o">=</span> <span class="n">hog</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>以上をまとめると、HOGを計算する関数を以下のように定義できる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_hog</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># patch size</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># block size</span>
    <span class="n">n_angles</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1"># number of angle bins</span>

    <span class="n">ph</span> <span class="o">=</span> <span class="n">h</span> <span class="o">//</span> <span class="n">s</span>  <span class="c1"># number of vertical patches</span>
    <span class="n">pw</span> <span class="o">=</span> <span class="n">w</span> <span class="o">//</span> <span class="n">s</span>  <span class="c1"># number of horizontal patches</span>

    <span class="c1"># Divide image into patches, then compute orientation histogram for each patch</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="p">)]</span>
    <span class="n">hists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">calc_hist</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n_angles</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">])</span>
    <span class="n">hists</span> <span class="o">=</span> <span class="n">hists</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ph</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Normalize histogram within each block of patches</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">hists</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">bs</span><span class="p">,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">bs</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span> <span class="o">-</span> <span class="n">bs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pw</span> <span class="o">-</span> <span class="n">bs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">hog</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_angles</span> <span class="o">*</span> <span class="n">bs</span> <span class="o">*</span> <span class="n">bs</span><span class="p">))</span>
    <span class="n">hog</span> <span class="o">=</span> <span class="n">hog</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hog</span> <span class="o">*</span> <span class="n">hog</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.0e-8</span><span class="p">)</span>
    <span class="n">hog</span> <span class="o">=</span> <span class="n">hog</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">hog</span>
</pre></div>
</div>
</div>
</div>
<p>計算されたHOGを用いて、再度SVMを用いた分類を試してみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hog</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_hog</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X</span><span class="p">)]</span>
<span class="n">X_hog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_hog</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e32f1d8a93be4ed0aa533bbb7dae0444", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf5</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf5</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_hog</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "81cba8a354ce4e99915aa9a7d9d45122", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf5</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_hog</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;hog_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;HOG&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hog_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_hog</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X_test</span><span class="p">)]</span>
<span class="n">X_hog_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_hog_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "92d69256d78f4ebb95e9a6627c515953", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テストデータに対する識別精度の計算</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf5</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_hog_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;hog_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;HOG&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: Histogram of Oriented Gradientの利用</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">48.15</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">44.93</span>%</p></li>
</ul>
</section>
<section id="bag-of-visual-words">
<h2><span class="section-number">2.5. </span>Bag of Visual Words<a class="headerlink" href="#bag-of-visual-words" title="Permalink to this heading">#</a></h2>
<p>ここまでの特徴量は、画素の情報を元にして何らかのヒストグラムを得る、という方法であったが、続いては、画像に内在する画像の構造としての特徴を疎に抽出し、その特徴の集合をヒストグラム化する手法である<strong>Bag of Visual Words</strong> (BoVW, Bag of Featuresとも呼ばれる)について見ていく。</p>
<p>BoVWは、自然言語処理分野の<strong>Bag of Words</strong>から着想を得たもので、元のBag of Wordsは辞書に登録された各単語が文書の中に何回登場するかをヒストグラムとして表わした物である。</p>
<p>これに対してBag of Visual Wordsは、画像データセットから抽出された疎な特徴量の集合を単語の集まりだと見なす。ただし、画像から得られる特徴量は通常連続的であるため、特徴量をあらかじめクラスタ分割しておき、各特徴が属するクラスタを単語、クラスタの集まりを辞書と見なすことでBag of Wordsと同様の処理を可能にする。</p>
<p>以下では、画像に対する疎な特徴量の代表格である<strong>Scale-Invariant Feature Transform</strong> (SIFT)について、BoVWによる画像認識を試みる。</p>
<section id="scale-invariant-feature-transform-sift">
<h3><span class="section-number">2.5.1. </span>Scale-Invariant Feature Transform (SIFT)<a class="headerlink" href="#scale-invariant-feature-transform-sift" title="Permalink to this heading">#</a></h3>
<p>Scale-Invariant Feature Transform (SIFT)は、深層学習以前の画像認識における金字塔的な技術で、2000年前後にRoweらによって提案された<span id="id9">[<a class="reference internal" href="#id32" title="David G Lowe. Object recognition from local scale-invariant features. In Proceedings of the seventh IEEE international conference on computer vision, volume 2, 1150–1157. Ieee, 1999. doi:10.1109/iccv.1999.790410.">Lowe, 1999</a>]</span>, <span id="id10">[<a class="reference internal" href="#id33" title="David G Lowe. Distinctive image features from scale-invariant keypoints. International journal of computer vision, 60:91–110, 2004. doi:10.1023/b:visi.0000029664.99615.94.">Lowe, 2004</a>]</span>。SIFTは画像の中に映り込む物体のスケールや回転に対して不変な特徴量を与えることができる。</p>
<p>SIFT特徴量の抽出処理は、少々複雑だが、大まかに分けて</p>
<ul class="simple">
<li><p>特徴点の抽出</p></li>
<li><p>特徴点に対する特徴量の計算</p></li>
</ul>
<p>の二つの処理に分けられる。</p>
<section id="id11">
<h4>特徴点の抽出<a class="headerlink" href="#id11" title="Permalink to this heading">#</a></h4>
<p><strong>特徴点の抽出</strong>に置いては、Difference of Gaussian (DoG)というフィルタを用いて、特徴点のスケールを計算する。DoGは二つの異なる<span class="math notranslate nohighlight">\(\sigma_1\)</span>, <span class="math notranslate nohighlight">\(\sigma_2\)</span> (ただし<span class="math notranslate nohighlight">\(\sigma_1 &lt; \sigma_2\)</span>とする)を用いて、</p>
<div class="math notranslate nohighlight">
\[
\text{DoG}(I) = G_{\sigma_1} \otimes I - G_{\sigma_2} \otimes I
\]</div>
<p>のように書ける。ただし<span class="math notranslate nohighlight">\(G_\sigma\)</span>は<span class="math notranslate nohighlight">\(\sigma\)</span>を標準偏差のパラメータとするGauss関数とする。例えば、以下のような画像になる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)),</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
<span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">B1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigmaX</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">B2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigmaX</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
<span class="n">DoG</span> <span class="o">=</span> <span class="n">B1</span> <span class="o">-</span> <span class="n">B2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Input image&quot;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">DoG</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Difference of Gaussian&quot;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/af821eb64e65886cdded65dfafa3c8110ee26aa6b4c2972c038af12e0e0c8c93.png" src="../../_images/af821eb64e65886cdded65dfafa3c8110ee26aa6b4c2972c038af12e0e0c8c93.png" />
</div>
</div>
<p>DoGの抽出を初期のパラメータ<span class="math notranslate nohighlight">\(\sigma\)</span>とスケールパラメータ<span class="math notranslate nohighlight">\(k\)</span>を用いて、<span class="math notranslate nohighlight">\(k^n\sigma\)</span>と<span class="math notranslate nohighlight">\(k^{n+1}\sigma\)</span>の間で<span class="math notranslate nohighlight">\(n=0, 1, 2, ...\)</span>の順で計算をしていく。この計算の過程でDoGの値が極値を取っていたら、そこをキーポイントの候補点として選ぶ。</p>
<p>選ばれた候補点が実際に特徴点になるかどうかは、DoG値が極値を取るスケールにおいて、DoG画像<span class="math notranslate nohighlight">\(D\)</span>のその画素における勾配情報を参考にして決定する。具体的には、画像<span class="math notranslate nohighlight">\(D\)</span>から有限差分を用いて、ヘッセ行列</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{H} = \begin{bmatrix}
    D_{xx} &amp; D_{xy} \\
    D_{yx} &amp; D_{yy} 
\end{bmatrix}
\end{split}\]</div>
<p>を計算し、<span class="math notranslate nohighlight">\(\mathbf{H}\)</span>のトレースと行列式の比、</p>
<div class="math notranslate nohighlight" id="equation-eq-ratio-tr-det">
<span class="eqno">(2.2)<a class="headerlink" href="#equation-eq-ratio-tr-det" title="この数式へのパーマリンク">#</a></span>\[
\rho = \frac{(\text{tr} \mathbf{H})^2}{\text{det}\mathbf{H}}
\]</div>
<p>の値が一定の閾値<span class="math notranslate nohighlight">\(t\)</span>以下であれば、その候補特徴点を実際の特徴点として採用する。行列<span class="math notranslate nohighlight">\(\mathbf{H}\)</span>の固有値を<span class="math notranslate nohighlight">\(\lambda_1\)</span>, <span class="math notranslate nohighlight">\(\lambda_2\)</span> (ただし<span class="math notranslate nohighlight">\(\lambda_1 &gt; \lambda_2\)</span>とするとき、トレースと行列式は、それぞれ<span class="math notranslate nohighlight">\(\lambda_1 + \lambda_2\)</span>, <span class="math notranslate nohighlight">\(\lambda_1 \lambda_2\)</span>と表せるので、<a class="reference internal" href="#equation-eq-ratio-tr-det">(2.2)</a>は、</p>
<div class="math notranslate nohighlight">
\[
\rho = \frac{\left( \lambda_1 + \lambda_2 \right)^2}{\lambda_1 \lambda_2} = \frac{\left( 1 + \frac{\lambda_2}{\lambda_1} \right)^2}{\frac{\lambda_2}{\lambda_1}} = \frac{(1 + r)^2}{r^2}
\]</div>
<p>のように書き直せる。原論文では、<span class="math notranslate nohighlight">\(r = (\lambda_2 / \lambda_1) = 10\)</span>を用いて、閾値<span class="math notranslate nohighlight">\(t\)</span>を</p>
<div class="math notranslate nohighlight">
\[
t = \frac{(r + 1)^2}{r}
\]</div>
<p>のように定義している。<span class="math notranslate nohighlight">\(t\)</span>の値は<span class="math notranslate nohighlight">\(r\)</span>の変化に対して、以下のグラフのように、ほぼ線形に変化する。</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">r</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;$r$ vs $t$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/06a6b741ee5ac319e3943a264f60dde58a2ca054cae0e9abab6aab2bc9fc7fbf.png" src="../../_images/06a6b741ee5ac319e3943a264f60dde58a2ca054cae0e9abab6aab2bc9fc7fbf.png" />
</div>
</div>
<p>以上の処理を、直感的に述べれば、前半のDoGの処理は画像中の勾配がある箇所を検出し、さらに、その<strong>勾配がどの程度の鮮鋭度を持つのかをスケールとして定量化</strong>しようとしている。</p>
<p>後半の処理、勾配の強さ (鮮鋭度は盛り上がりの角度であり、強さとは異なる)を見ており、<span class="math notranslate nohighlight">\(r = 10\)</span>とした場合に<a class="reference internal" href="#equation-eq-ratio-tr-det">(2.2)</a>が<span class="math notranslate nohighlight">\(t\)</span>より小さい、ということは、即ち<strong>ヘッセ行列の2つの固有値の比が一定以下</strong> (10:1以下)かを検証している。</p>
<p>なお、この<span class="math notranslate nohighlight">\(r\)</span>の値は以下のOpenCVのコードでは<code class="docutils literal notranslate"><span class="pre">edgeThreshold</span></code>という変数に対応する。もし、各画像から検出される特徴点が少なすぎるようであれば、この値を少し上げると、固有値の差が小さい(=エッジがそれほど先鋭ではない)特徴点も残されるようになる。</p>
<p>また、詳細は割愛するが、各特徴点には、勾配方向も同時に計算される。これは特徴点周りの画素に対して計算された勾配方向のヒストグラムの中で、いくつかの支配的な方向を特徴点に与えるものである。従って、各特徴点には2つ以上の勾配方向が割り当てられる可能性がある。</p>
<hr class="docutils" />
<p>では、実際にOpenCVを用いて画像からSIFT特徴点と特徴量を計算する。以下では、特徴量の抽出結果を分かりやすくするために、48×48画素の画像を256×256画素にリサイズして特徴量を計算している。</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 画像のリサイズ</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>

<span class="c1"># 特徴量抽出器の準備</span>
<span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>

<span class="c1"># 特徴点の検出</span>
<span class="n">keypoints</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>前述の通り、SIFT特徴点の検出では、位置、スケール、勾配方向が計算されるので、それらを<code class="docutils literal notranslate"><span class="pre">cv2.drawKeypoints</span></code>で可視化してみる。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 特徴点の描画 (画像に書き込みをするだけで表示はしない)</span>
<span class="n">img_sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawKeypoints</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">keypoints</span><span class="p">,</span>
    <span class="kc">None</span><span class="p">,</span>
    <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">DRAW_MATCHES_FLAGS_DRAW_RICH_KEYPOINTS</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Input image&quot;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_sift</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2"> keypoints detected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keypoints</span><span class="p">)),</span>
    <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">yticks</span><span class="o">=</span><span class="p">[],</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/5b26bd93b8afde7e005d44e9b5cbd34ed44359de06cb92fe15c47d02fa90f449.png" src="../../_images/5b26bd93b8afde7e005d44e9b5cbd34ed44359de06cb92fe15c47d02fa90f449.png" />
</div>
</div>
<p>画像中では、円の中心が特徴点の位置を、円の大きさが特徴点のスケールを、そして円の中心から弧に向かって伸びる線分が勾配方向をそれぞれ表わしている。この際、文字の輪郭線のぼけ具合と円の大きさに相関があり、なおかつ勾配方向が輪郭線とおよそ直交する方向となっていることに注目してほしい。また、特徴点の中には2つ以上の勾配方向を持つものが存在することにも注目してほしい。</p>
</section>
<section id="id12">
<h4>特徴量の計算<a class="headerlink" href="#id12" title="Permalink to this heading">#</a></h4>
<p>特徴量の計算には、特徴点の計算で得られたスケールと方向を用いる。特徴量の計算には4×4のグリッドを用いるのだが、このグリッドの大きさを特徴点のスケールに応じて拡大縮小し、また勾配方向に応じてグリッドの向きを変更する。</p>
<p>このグリッドは上記の特徴点の可視化に現れる特徴点のスケールを表わす円に外接するように配置される。この円の大きさは、より具体的には極大のDoG値が検出された時に用いたGauss関数の<span class="math notranslate nohighlight">\(\sigma\)</span>の大きさに対応している。</p>
<p>グリッドの姿勢が計算できたら、4×4=16個のグリッドのそれぞれについて、特徴点の勾配方向ヒストグラムを45°刻みの8方向について計算する。この8個のビンの値を16個分連結することで、SIFT特徴量としての128次元ベクトルが得られる。</p>
<p>では、先ほど求めた特徴点に対して、OpenCVを用いて特徴量(記述子=descriptorとも言う)を計算する。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 特徴量の計算</span>
<span class="n">_</span><span class="p">,</span> <span class="n">features</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">keypoints</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(13, 128)
</pre></div>
</div>
</div>
</div>
<p>このように特徴量 (<code class="docutils literal notranslate"><span class="pre">features</span></code>)は「特徴点の数」×「特徴量の次元=128」で与えられることが確認できる。なお、特徴点の抽出と特徴量の計算は<code class="docutils literal notranslate"><span class="pre">sift.detectAndCompute</span></code>を用いることで同時に行うこともできる。</p>
<div class="note admonition">
<p class="admonition-title">技術と特許</p>
<p>新しい技術を開発して「特許」を取得すると、その技術の詳細を明細書として公開する代わりに、その技術に関わる権利を得ることができる。この特許は、一見、他の会社が当該の技術を使う障壁を上げており、技術の進歩にとってはマイナスな一面もある。</p>
<p>その一方、特許が取られていたがために、その技術を回避する目的で技術が進歩することもある。先に紹介したSIFTは当初2000年に特許が取得された(2020年に失効)が、それに変わる技術として、Speeded-Up Robust Features (SURF) <span id="id13">[<a class="reference internal" href="#id47" title="Herbert Bay, Tinne Tuytelaars, and Luc Van Gool. SURF: speeded up robust features. In Computer Vision – ECCV 2006, pages 404–417. Springer Berlin Heidelberg, 2006. doi:10.1007/11744023_32.">Bay <em>et al.</em>, 2006</a>]</span>などの多くの特徴量が提案された (SURFは2006年に特許が取得されており、こちらはまだ特許が切れていない)。</p>
<p>このような例は他の分野でも、たびたび見られるもので、CT画像から物体の表面形状を抽出するMarching Cubes法も、その特許権を回避する目的で、ほとんど同等なMarching Tetrahedra法が開発されたりした。このように、物事には表と裏とがあるのが常である。</p>
</div>
</section>
</section>
<section id="id14">
<h3><span class="section-number">2.5.2. </span>特徴量のクラスタリング<a class="headerlink" href="#id14" title="Permalink to this heading">#</a></h3>
<p>BoVWを計算するためには、訓練データに含まれる全ての画像について、特徴量を計算し、それをクラスタリングする必要がある。以下のコードでは、48×48という比較的小さな画像を扱うために<code class="docutils literal notranslate"><span class="pre">edgeThreshold</span></code>を調整して、検出される特徴点の数を増やしている。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extractor</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">(</span><span class="n">edgeThreshold</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">contrastThreshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
    <span class="n">keypoints</span><span class="p">,</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">keypoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No keypoints detected!&quot;</span>
    <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e0b6c2046ffb406794c7b61cd8c06485", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SIFT: </span><span class="si">{:d}</span><span class="s2"> keypoints are detected!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SIFT: 877082 keypoints are detected!
</pre></div>
</div>
</div>
</div>
<p>特徴量が得られたら、これをk平均法 (k-means法)によってクラスタリングする。今回は、scikit-learnの<code class="docutils literal notranslate"><span class="pre">MiniBatchKMeans</span></code>を用いてクラスタリングを行う (<code class="docutils literal notranslate"><span class="pre">KMeans</span></code>というクラスもあるが、こちらは計算にかなり時間がかかる)。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">MiniBatchKMeans</span> <span class="k">as</span> <span class="n">KMeans</span>

<span class="n">cb_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="bp">cls</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">cb_size</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.0e-4</span><span class="p">)</span>
<span class="bp">cls</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 10.3 s, sys: 7.84 s, total: 18.1 s
Wall time: 2.3 s
</pre></div>
</div>
<div class="output text_html"><style>#sk-container-id-1 {color: black;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>MiniBatchKMeans(max_iter=1000, n_clusters=128, tol=0.0001)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">MiniBatchKMeans</label><div class="sk-toggleable__content"><pre>MiniBatchKMeans(max_iter=1000, n_clusters=128, tol=0.0001)</pre></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_bovw</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">cb_size</span><span class="p">)</span>
    <span class="n">X_bovw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>

<span class="n">X_bovw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_bovw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "84dbeb78863f41c495f33b70ac0fad02", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf6</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf6</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bovw</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "09c344c90d294f2286e0d386151a7585", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf6</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_bovw</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;bovw_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BoVW&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_bovw_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X_test</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
    <span class="n">keypoints</span><span class="p">,</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">keypoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No keypoints detected!&quot;</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">cb_size</span><span class="p">)</span>
    <span class="n">X_bovw_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>

<span class="n">X_bovw_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_bovw_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "41d644a1427f442eb9c2d5bf3a42fb3e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テスト時の識別精度の確認</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf6</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_bovw_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;bovw_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BoVW&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: Bag of Visual Wordsの利用</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">60.45</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">58.44</span>%</p></li>
</ul>
</section>
<section id="gauss">
<h3><span class="section-number">2.5.3. </span>Gauss混合モデルを用いた改良<a class="headerlink" href="#gauss" title="Permalink to this heading">#</a></h3>
<p>上記の例では、離散的に特徴量をクラスタ分割して、<strong>最も近いクラスタ</strong>に対して、各特量を割り当てることでヒストグラムを作成した。ただし、複数のクラスタの境界に特徴量が存在している可能性もあるため、その情報を捨てて、一番近いクラスタに特徴量を割り当てるのは、あまり適切とは言えない。</p>
<p>そこで、クラスタリングを用いる代わりに、特徴量の分布をGauss混合モデルによって近似しておき、各ガウス分布への寄与 (小数で表わされる)の和を画像の特徴ベクトルとして与えることを考える。</p>
<p><strong>Gauss混合モデル</strong>とは、複数のGauss分布を和が1となるような正の重みによって重み付けたものであり、確率密度関数<span class="math notranslate nohighlight">\(P(\mathbf{x} | \boldsymbol\Theta)\)</span>, <span class="math notranslate nohighlight">\(\mathbf{x} \in \mathbb{R}^D\)</span>が以下の形で書ける。</p>
<div class="math notranslate nohighlight" id="equation-eq-gaussian-mixture">
<span class="eqno">(2.3)<a class="headerlink" href="#equation-eq-gaussian-mixture" title="この数式へのパーマリンク">#</a></span>\[
P(\mathbf{x} | \boldsymbol\Theta) = \sum_{k=1}^K \frac{\alpha_k}{(2 \pi)^{D / 2} \left| \boldsymbol\Sigma_k \right|^{1/2}} \exp \left( - \frac{1}{2}(\mathbf{x} - \boldsymbol{\mu}_k)^\top \boldsymbol\Sigma_k^{-1}  (\mathbf{x} - \boldsymbol{\mu}_k) \right)
\]</div>
<p>のように書ける。この式で<span class="math notranslate nohighlight">\(\boldsymbol\Theta\)</span>はパラメータの集合 <span class="math notranslate nohighlight">\(\{ \alpha_k, \boldsymbol\mu_k, \boldsymbol\Sigma_k : k = 1, \ldots, K \}\)</span>を表わし、<span class="math notranslate nohighlight">\(\alpha_k \in [0, 1)\)</span>, <span class="math notranslate nohighlight">\(\boldsymbol\mu_k \in \mathbb{R}^D\)</span>, <span class="math notranslate nohighlight">\(\boldsymbol\Sigma_k \in \mathbb{R}^{D \times D}\)</span>は、それぞれ<span class="math notranslate nohighlight">\(k\)</span>番目のGauss分布に対する混合率、分布中心、共分散行列を表わす。</p>
<p>ガウス混合分布を用いると、とある特徴量<span class="math notranslate nohighlight">\(\mathbf{x}\)</span>が<span class="math notranslate nohighlight">\(k\)</span>個のGauss分布のそれぞれにどの程度の寄与率<span class="math notranslate nohighlight">\(\gamma_k(\mathbf{x})\)</span>を持つかを以下のように計算できる。</p>
<div class="math notranslate nohighlight" id="equation-eq-membership">
<span class="eqno">(2.4)<a class="headerlink" href="#equation-eq-membership" title="この数式へのパーマリンク">#</a></span>\[
\gamma_k(\mathbf{x}) = \frac{\alpha_k}{(2\pi)^{D/2} \left| \boldsymbol\Sigma_k \right|^{1/2}}\frac{\exp \left( - \frac{1}{2}(\mathbf{x} - \boldsymbol{\mu}_k)^\top \boldsymbol\Sigma_k^{-1}  (\mathbf{x} - \boldsymbol{\mu}_k) \right) }{P(\mathbf{x})}
\]</div>
<p>これにより、特徴量<span class="math notranslate nohighlight">\(\mathbf{x}\)</span>に対する、特徴表現として、</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol\gamma = (\gamma_1(\mathbf{x}), \ldots, \gamma_K(\mathbf{x})^\top
\]</div>
<p>が得られる。これを画像に含まれる特徴量の集合<span class="math notranslate nohighlight">\(\mathcal{X} = \{ \mathbf{x}_i : i = 1, \ldots, N \}\)</span>に対して計算し、その平均値を画像の特徴ベクトルとする。</p>
<div class="math notranslate nohighlight">
\[
\mathbf{f}(\mathcal{X}) = \frac{1}{N} \sum_{i=1}^N \boldsymbol\gamma(\mathbf{x}_i)
\]</div>
<p>ここまでの議論を踏まえて、BoVWを改善したコードが以下になる。ここではscikit-learnの<code class="docutils literal notranslate"><span class="pre">GaussianMixture</span></code>を用いてGauss混合モデルのフィッティングを行う。ただし、Gauss混合モデルのフィッティングは、かなり時間のかかる処理であるため、計算時間を短縮するために、最初に主成分分析で特徴量の次元を減らしておき、そのデータに対してGauss混合モデルをフィッティングする。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">sub_features</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 53.5 s, sys: 15 s, total: 1min 8s
Wall time: 7.75 s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="kn">import</span> <span class="n">GaussianMixture</span>

<span class="n">gmm</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span>
    <span class="n">n_components</span><span class="o">=</span><span class="n">cb_size</span><span class="p">,</span>
    <span class="n">covariance_type</span><span class="o">=</span><span class="s2">&quot;diag&quot;</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">,</span>
    <span class="n">n_init</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">gmm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sub_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 12min 52s, sys: 2min 21s, total: 15min 13s
Wall time: 2min 9s
</pre></div>
</div>
<div class="output text_html"><style>#sk-container-id-2 {color: black;}#sk-container-id-2 pre{padding: 0;}#sk-container-id-2 div.sk-toggleable {background-color: white;}#sk-container-id-2 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-2 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-2 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-2 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-2 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-2 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-2 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-2 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-2 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-2 div.sk-item {position: relative;z-index: 1;}#sk-container-id-2 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-2 div.sk-item::before, #sk-container-id-2 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-2 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-2 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-2 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-2 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-2 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-2 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-2 div.sk-label-container {text-align: center;}#sk-container-id-2 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-2 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>GaussianMixture(covariance_type=&#x27;diag&#x27;, max_iter=20, n_components=128)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox" checked><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">GaussianMixture</label><div class="sk-toggleable__content"><pre>GaussianMixture(covariance_type=&#x27;diag&#x27;, max_iter=20, n_components=128)</pre></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_bovw2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="n">sub_f</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">sub_f</span><span class="p">)</span>
    <span class="n">X_bovw2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">X_bovw2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_bovw2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7eb1c23caf094d12b97a06b55ffe7f1a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf7</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf7</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bovw2</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "200682aef6674ace80a65f9fa62295ff", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf7</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_bovw2</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;bovwg_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GMM-BoVW&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_bovw2_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X_test</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">sub_f</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">sub_f</span><span class="p">)</span>
    <span class="n">X_bovw2_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">X_bovw2_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_bovw2_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "05ba249ba7254afda9603fa94a829d7d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テスト時の識別精度の確認</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf7</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_bovw2_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;bovwg_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GMM-BoVW&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: GMM-BoVW</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">64.00</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">62.37</span>%</p></li>
</ul>
</section>
<section id="fisher">
<h3><span class="section-number">2.5.4. </span>Fisherベクトルの利用<a class="headerlink" href="#fisher" title="Permalink to this heading">#</a></h3>
<p>BoVWの改良としてFisherベクトルを利用する手法は2007年にPerronninらによって提案された<span id="id15">[<a class="reference internal" href="#id49" title="Florent Perronnin and Christopher Dance. Fisher kernels on visual vocabularies for image categorization. In 2007 IEEE Conference on Computer Vision and Pattern Recognition. IEEE, jun 2007. doi:10.1109/cvpr.2007.383266.">Perronnin and Dance, 2007</a>]</span>。Fisherベクトルは、統計学等でも用いられるFisher情報量に基づく特徴表現である。とある確率密度分布が<span class="math notranslate nohighlight">\(\mathbf{x} \in \mathcal{X}\)</span>のパラメータ (母数)<span class="math notranslate nohighlight">\(\boldsymbol\Theta\)</span>に関する事後分布として <span class="math notranslate nohighlight">\(P(\mathbf{x} | \boldsymbol\Theta)\)</span>のように与えられる場合を考える。</p>
<section id="id16">
<h4>Fisherベクトルの導出<a class="headerlink" href="#id16" title="Permalink to this heading">#</a></h4>
<p>Fisher情報量を求めるに当たり、Fisherベクトル<span class="math notranslate nohighlight">\(V(\mathbf{x}; \boldsymbol\Theta)\)</span>を</p>
<div class="math notranslate nohighlight">
\[
V(\mathbf{x}; \boldsymbol\Theta) = \nabla_{\boldsymbol\Theta} \log P(\mathbf{x} | \boldsymbol\Theta)
\]</div>
<p>のように表わす。なお、確率密度関数が連続関数であるとき、このFisherベクトルの平均はゼロベクトルになる。</p>
<p>Fisher情報量は上記のFisherベクトルの分散として定義される。この際、Fisherベクトルの平均が<span class="math notranslate nohighlight">\(\mathbf{0}\)</span>であることを用いると次の式で与えられる。</p>
<div class="math notranslate nohighlight">
\[
\mathbb{E}_{\mathbf{x} \sim \mathcal{X}} \left[ \nabla_{\boldsymbol\Theta} \log P(\mathbf{x} | \boldsymbol\Theta)) \right]
\]</div>
<p>さて、ここで、<span class="math notranslate nohighlight">\(P(\mathbf{x} | \boldsymbol\Theta)\)</span>が<a class="reference internal" href="#equation-eq-gaussian-mixture">(2.3)</a>のガウス混合分布で与えられる場合を考える。以後、計算を簡単にするために、共分散行列は対角成分を<span class="math notranslate nohighlight">\(\boldsymbol\sigma_k\)</span>とする対角行列であるとする。</p>
<p>とあるパラメータ<span class="math notranslate nohighlight">\(\theta\)</span>に関する<span class="math notranslate nohighlight">\(\ln P(\mathbf{x} | \boldsymbol\Theta)\)</span>の微分は、</p>
<div class="math notranslate nohighlight">
\[
\frac{\partial \log P(\mathbf{x}| \boldsymbol\Theta)}{\partial \theta} = \frac{1}{P(\mathbf{x} | \boldsymbol\Theta)} \frac{\partial P}{\partial\theta}
\]</div>
<p>と書けることは言うまでもない。また、<span class="math notranslate nohighlight">\(P(\mathbf{x} | \boldsymbol\Theta)\)</span>の<span class="math notranslate nohighlight">\(\pi_k\)</span>, <span class="math notranslate nohighlight">\(\mu_{k,d}\)</span>, <span class="math notranslate nohighlight">\(\sigma_{k,d}\)</span>に関する偏微分はそれぞれ以下のように書ける。</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
\frac{\partial P(\mathbf{x} | \boldsymbol\Theta)}{\partial \alpha_k}
&amp;= \frac{\exp \left( -\frac{1}{2}(\mathbf{x} - \boldsymbol{\mu}_k)^\top \boldsymbol\Sigma_k^{-1}  (\mathbf{x} - \boldsymbol{\mu}_k) \right)}{(2\pi)^{D/2} | \boldsymbol\Sigma_k |^{1/2}} = \frac{\mathcal{N}(\mathbf{x} | \boldsymbol\mu_{k}, \boldsymbol\sigma_k)}{\alpha_k} \\
%
\frac{\partial P(\mathbf{x} | \boldsymbol\Theta)}{\partial \mu_{k,d}}
&amp;= \alpha_k \left[ \frac{x_d - \mu_{k,d}}{\sigma_{k,d}^2} \right] \mathcal{N}(\mathbf{x} | \boldsymbol\mu_{k}, \boldsymbol\sigma_k) \\
%
\frac{\partial P(\mathbf{x} | \boldsymbol\Theta)}{\partial \sigma_{k,d}}
&amp;= \alpha_k \left[ \frac{(x_d - \mu_{k,d})^2}{\sigma_{k,d}^3} - \frac{1}{\sigma_{k,d}} \right] \mathcal{N}(\mathbf{x} | \boldsymbol\mu_{k}, \boldsymbol\sigma_k)
\end{align}
\end{split}\]</div>
<p>したがって、<a class="reference internal" href="#equation-eq-membership">(2.4)</a>の寄与率<span class="math notranslate nohighlight">\(\gamma_k\)</span>を用いると、フィッシャーベクトルの各次元は以下のように書き直せる。</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
\frac{\partial \log P(\mathbf{x}| \boldsymbol\Theta)}{\partial \alpha_k}
&amp;= \frac{\gamma_k(\mathbf{x})}{\alpha_k} \\
%
\frac{\partial \log P(\mathbf{x}| \boldsymbol\Theta)}{\partial \mu_{k,d}}
&amp;= \gamma_k(\mathbf{x}) \left[ \frac{x_d - \mu_{k,d}}{\sigma_{k,d}^2} \right] \\
%
\frac{\partial \log P(\mathbf{x}| \boldsymbol\Theta)}{\partial \sigma_{k,d}}
&amp;= \gamma_k(\mathbf{x}) \left[ \frac{(x_d - \mu_{k,d})^2}{\sigma_{k,d}^3}  - \frac{1}{\sigma_{k,d}} \right]
\end{align}
\end{split}\]</div>
<p>ここで、<span class="math notranslate nohighlight">\(\mathcal{X} = \{ \mathbf{x}_1, \ldots, \mathbf{x}_N \}\)</span>として、これらの同時分布<span class="math notranslate nohighlight">\(P(\mathcal{X} | \boldsymbol\Theta)\)</span>を考える。<span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span>は互いに独立なサンプルであるので、</p>
<div class="math notranslate nohighlight">
\[
P(\mathcal{X} | \boldsymbol\Theta) = \prod_{i=1}^N P(\mathbf{x}_i | \boldsymbol\Theta)
\]</div>
<p>故に、この対数尤度<span class="math notranslate nohighlight">\(L(\mathcal{X} | \boldsymbol\Theta)\)</span>は、</p>
<div class="math notranslate nohighlight">
\[
L(\mathcal{X} | \boldsymbol\Theta) = \sum_{i=1}^N \log P(\mathbf{x}_i | \boldsymbol\Theta)
\]</div>
<p>となることが分かる。この尤度関数のパラメータに関する偏微分からFisherベクトルを求めると、以下のようになる。</p>
<div class="math notranslate nohighlight" id="equation-eq-deriv-alpha">
<span class="eqno">(2.5)<a class="headerlink" href="#equation-eq-deriv-alpha" title="この数式へのパーマリンク">#</a></span>\[
\frac{\partial L(\mathcal{X} | \boldsymbol\Theta)}{\partial \alpha_k}
= \sum_{i=1}^N \left[ \frac{\gamma_k(\mathbf{x}_i)}{\alpha_k} - \frac{\gamma_1(\mathbf{x}_i)}{\alpha_1}  \right] \quad \text{for} ~ k \geq 2  \]</div>
<div class="math notranslate nohighlight" id="equation-eq-deriv-mu">
<span class="eqno">(2.6)<a class="headerlink" href="#equation-eq-deriv-mu" title="この数式へのパーマリンク">#</a></span>\[\begin{split}
\frac{\partial L(\mathcal{X} | \boldsymbol\Theta)}{\partial \mu_{k,d}}
= \sum_{i=1}^N \gamma_k(\mathbf{x}_i) \left[ \frac{x_d - \mu_{k,d}}{\sigma_{k,d}^2} \right] \\
\end{split}\]</div>
<div class="math notranslate nohighlight" id="equation-eq-deriv-sigma">
<span class="eqno">(2.7)<a class="headerlink" href="#equation-eq-deriv-sigma" title="この数式へのパーマリンク">#</a></span>\[
\frac{\partial L(\mathcal{X} | \boldsymbol\Theta)}{\partial \sigma_{k,d}}
= \sum_{i=1}^N \gamma_k(\mathbf{x}_i) \left[ \frac{(x_d - \mu_{k,d})^2}{\sigma_{k,d}^3} - \frac{1}{\sigma_{k,d}} \right]
\]</div>
<p>ただし、<a class="reference internal" href="#equation-eq-deriv-alpha">(2.5)</a>では、<span class="math notranslate nohighlight">\(\sum_{k} \alpha_k = 1\)</span>であることを用いて、自由度を一つ減らしてある。</p>
<p>ここまでの式から、Fisherベクトルの次元は<span class="math notranslate nohighlight">\(\alpha_k\)</span>に関する成分が<span class="math notranslate nohighlight">\(K - 1\)</span>次元、<span class="math notranslate nohighlight">\(\mu_{k,d}\)</span>に関する成分が<span class="math notranslate nohighlight">\(DK\)</span>次元、<span class="math notranslate nohighlight">\(\sigma_{k,d}\)</span>に関する成分が<span class="math notranslate nohighlight">\(DK\)</span>次元あるので、合計で<span class="math notranslate nohighlight">\((2D + 1) K - 1\)</span>次元となる。</p>
</section>
<section id="id17">
<h4>Fisherベクトルの意味<a class="headerlink" href="#id17" title="Permalink to this heading">#</a></h4>
<p>上記の通り、Fisherベクトルはとあるデータ集合<span class="math notranslate nohighlight">\(\mathcal{X}\)</span>を近似的に表わすGauss混合モデルについて、そのパラメータ<span class="math notranslate nohighlight">\(\boldsymbol\Theta\)</span>に関する勾配を要素に持つ。この意味を考えてみよう。</p>
<p>とある確率密度関数をサンプルにフィッティングする問題を考えるとき、その確率密度関数の対数尤度が最大になるようにパラメータを最適化する。従って、<strong>Fisherベクトルの各要素は、そのパラメータの変化が、どの程度尤度に影響を与えるかを示している</strong>、と言い換えられる。</p>
<p>この影響を大きさの期待値を表わしているのがFisher情報量であり、各パラメータに関するFisher情報両はFisherベクトルの各要素の二乗平均により与えられる。Fisher情報量は、推定するパラメータを正しく推定するために、どの程度十分な情報(=サンプル)が得られているかを示しており、<strong>情報量が大きければ大きいほど、サンプルから求まるパラメータの最尤推定量が真の値に近づくことが期待される</strong> (推定量の分散とFisher情報量の逆数の関係はCramér-Raoの不等式で与えられる)。</p>
<p>従って、とある画像に対して計算されるFisherベクトルは、<strong>その画像(から得られた特徴量の集合)が、画像全体(のGauss混合分布)から見て、どのようなの意外性を持つか、と言い換えても良い</strong>。その画像が全体のGauss混合分布にとって十分尤もらしいものであれば、尤度の勾配から定まるFisherベクトルの要素は小さな値(特に意外ではない)を取り、そうでなければ、大きな値(意外である)を取る、という訳である。</p>
<p>ただし、画像の分類の観点から言えば、Fisherベクトルがどのような意味を持つか、ということよりも、それ自体が、単なるクラスタへの所属や、Gauss混合モデル以上に画像を上手く表現できるような特徴を与えるということに価値がある。</p>
<p>実際、<a class="reference internal" href="#equation-eq-deriv-alpha">(2.5)</a>は画像が含む特徴量に関して、どの分布にどのくらいの割合で属するかを表わす0次統計量であるのに対し、<a class="reference internal" href="#equation-eq-deriv-mu">(2.6)</a>ならびに<a class="reference internal" href="#equation-eq-deriv-sigma">(2.7)</a>は、それぞれ1次統計量、2次統計量を表わしている。</p>
</section>
<section id="id18">
<h4>Fisherベクトルを用いた画像分類<a class="headerlink" href="#id18" title="Permalink to this heading">#</a></h4>
<p>それでは、実際に全画像から取得したSIFT特徴量を用いて、各画像に対応するFisherベクトルを求めてみよう。Perronninらの元論文 <span id="id19">[<a class="reference internal" href="#id49" title="Florent Perronnin and Christopher Dance. Fisher kernels on visual vocabularies for image categorization. In 2007 IEEE Conference on Computer Vision and Pattern Recognition. IEEE, jun 2007. doi:10.1109/cvpr.2007.383266.">Perronnin and Dance, 2007</a>]</span>では、計算量を削減するために、得られたSIFT特徴量を主成分分析によって50次元減らした後、Gauss混合モデルをフィッティングしてFisherベクトルを求めている。</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_fv</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="n">sub_f</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>  <span class="c1"># (N, D)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">sub_f</span><span class="p">)</span>  <span class="c1"># (N, K)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">weights_</span>  <span class="c1"># (K)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">means_</span>  <span class="c1"># (K, D)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">covariances_</span>  <span class="c1"># (K, D)</span>

    <span class="n">g_over_a</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">/</span> <span class="n">alpha</span>
    <span class="n">dLda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g_over_a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">g_over_a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">tmp0</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_f</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dLdm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">tmp0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">tmp0</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_f</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">dLds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmp0</span> <span class="o">-</span> <span class="n">tmp1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">fv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dLda</span><span class="p">,</span> <span class="n">dLdm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dLds</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">))])</span>
    <span class="n">X_fv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>

<span class="n">X_fv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_fv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "067a99124f1940f68cff54add950752f", "version_major": 2, "version_minor": 0}</script></div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf8</span> <span class="o">=</span> <span class="n">MySGDClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">sgd_params</span><span class="p">)</span>
<span class="n">clf8</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fv</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6a7591b4a21544909f3c5c9d0b9be1e4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 訓練時の識別精度の確認</span>
<span class="n">acc_train</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf8</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_fv</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;fisher_acc_train&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Fisher-BoVW&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="s2">&quot;Train&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_fv_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">X_test</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">sub_f</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>  <span class="c1"># (N, D)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">sub_f</span><span class="p">)</span>  <span class="c1"># (N, K)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">weights_</span>  <span class="c1"># (K)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">means_</span>  <span class="c1"># (K, D)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">covariances_</span>  <span class="c1"># (K, D)</span>

    <span class="n">g_over_a</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">/</span> <span class="n">alpha</span>
    <span class="n">dLda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g_over_a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">g_over_a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">tmp0</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_f</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dLdm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">tmp0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">tmp0</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_f</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">dLds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmp0</span> <span class="o">-</span> <span class="n">tmp1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">fv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dLda</span><span class="p">,</span> <span class="n">dLdm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dLds</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">))])</span>
    <span class="n">X_fv_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>

<span class="n">X_fv_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_fv_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "24c9378bdb8c4439b749266070b79a90", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># テスト時の識別精度の確認</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">clf8</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_fv_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;fisher_acc_test&quot;</span><span class="p">,</span> <span class="n">acc_train</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Fisher-BoVW&quot;</span><span class="p">,</span> <span class="n">acc_test</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>結果: FisherベクトルによるBoVW</strong></p>
<ul class="simple">
<li><p>訓練時精度: <span class="pasted-text">94.10</span>%</p></li>
<li><p>評価時精度: <span class="pasted-text">94.10</span>%</p></li>
</ul>
</section>
</section>
</section>
<section id="id20">
<h2><span class="section-number">2.6. </span>手法の比較<a class="headerlink" href="#id20" title="Permalink to this heading">#</a></h2>
<p>ここまでの手法の訓練時、ならびにテスト時のスコアを比較してみよう。今回は文字のデータを使ったために、HOGなどが画像をそのまま入力する場合と比べて若干振るわない結果となったが、BoVWなどは、画像をそのまま入力する場合と比べて大幅に高いスコアを出すことができており、特徴量抽出により、画像から分類に有益な情報を引き出せていることが分かる。</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Method&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Phase&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">result_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">errwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">containers</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">bar_label</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">105</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/c81c25bef339dc7d140825f5ae189ef224ad0bd8c3b435832a617056d1e139ef.png" src="../../_images/c81c25bef339dc7d140825f5ae189ef224ad0bd8c3b435832a617056d1e139ef.png" />
</div>
</div>
</section>
<section id="id21">
<h2><span class="section-number">2.7. </span>練習問題<a class="headerlink" href="#id21" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>LBPとUniform LBPについて、文字の画像の輝度を増減したり、画像を回転させたときに、その特徴量がどのように変化するかを調べよ。</p></li>
<li><p>SIFT特徴量がスケールや画像の回転に対して頑健であるのは何故か。その計算方法に基づき説明せよ。</p></li>
<li><p>k平均法やGauss混合モデルは、教師なし学習法の一種で、そのクラスタや分布の数はユーザが必要に応じて与える必要がある。これらを自動的に決めるための指標として赤池情報基準(AIC = Akaike Information Criterion)やBayes情報基準 (=Bayes Information Criterion)がある。それぞれがどのようなものか調べよ。</p></li>
<li><p>BoVWの性能がSIFT以外の特徴量 (OpenCVにはBRIEF <span id="id22">[<a class="reference internal" href="#id50" title="Michael Calonder, Vincent Lepetit, Christoph Strecha, and Pascal Fua. BRIEF: binary robust independent elementary features. In Computer Vision – ECCV 2010, pages 778–792. Springer Berlin Heidelberg, 2010. doi:10.1007/978-3-642-15561-1_56.">Calonder <em>et al.</em>, 2010</a>]</span> (=Binary Robust Independent Elementary Features)やORB <span id="id23">[<a class="reference internal" href="#id51" title="Ethan Rublee, Vincent Rabaud, Kurt Konolige, and Gary Bradski. ORB: an efficient alternative to SIFT or SURF. In 2011 International Conference on Computer Vision. IEEE, nov 2011. doi:10.1109/iccv.2011.6126544.">Rublee <em>et al.</em>, 2011</a>]</span> (=Oriented FAST and Rotated BRIEF)が実装されている)を使うと、どのように変化するかを調べよ。</p></li>
</ol>
</section>
<section id="id24">
<h2><span class="section-number">2.8. </span>参考文献<a class="headerlink" href="#id24" title="Permalink to this heading">#</a></h2>
<div class="docutils container" id="id25">
<dl class="citation">
<dt class="label" id="id47"><span class="brackets"><a class="fn-backref" href="#id13">BTG06</a></span></dt>
<dd><p>Herbert Bay, Tinne Tuytelaars, and Luc Van Gool. SURF: speeded up robust features. In <em>Computer Vision – ECCV 2006</em>, pages 404–417. Springer Berlin Heidelberg, 2006. <a class="reference external" href="https://doi.org/10.1007/11744023_32">doi:10.1007/11744023_32</a>.</p>
</dd>
<dt class="label" id="id50"><span class="brackets"><a class="fn-backref" href="#id22">CLSF10</a></span></dt>
<dd><p>Michael Calonder, Vincent Lepetit, Christoph Strecha, and Pascal Fua. BRIEF: binary robust independent elementary features. In <em>Computer Vision – ECCV 2010</em>, pages 778–792. Springer Berlin Heidelberg, 2010. <a class="reference external" href="https://doi.org/10.1007/978-3-642-15561-1_56">doi:10.1007/978-3-642-15561-1_56</a>.</p>
</dd>
<dt class="label" id="id31"><span class="brackets"><a class="fn-backref" href="#id8">DT05</a></span></dt>
<dd><p>N. Dalal and B. Triggs. Histograms of oriented gradients for human detection. In <em>2005 IEEE Computer Society Conference on Computer Vision and Pattern Recognition (CVPR\textquotesingle 05)</em>, volume 1, 886–893. IEEE, IEEE, 2005. <a class="reference external" href="https://doi.org/10.1109/cvpr.2005.177">doi:10.1109/cvpr.2005.177</a>.</p>
</dd>
<dt class="label" id="id32"><span class="brackets"><a class="fn-backref" href="#id9">Low99</a></span></dt>
<dd><p>David G Lowe. Object recognition from local scale-invariant features. In <em>Proceedings of the seventh IEEE international conference on computer vision</em>, volume 2, 1150–1157. Ieee, 1999. <a class="reference external" href="https://doi.org/10.1109/iccv.1999.790410">doi:10.1109/iccv.1999.790410</a>.</p>
</dd>
<dt class="label" id="id33"><span class="brackets"><a class="fn-backref" href="#id10">Low04</a></span></dt>
<dd><p>David G Lowe. Distinctive image features from scale-invariant keypoints. <em>International journal of computer vision</em>, 60:91–110, 2004. <a class="reference external" href="https://doi.org/10.1023/b:visi.0000029664.99615.94">doi:10.1023/b:visi.0000029664.99615.94</a>.</p>
</dd>
<dt class="label" id="id27"><span class="brackets"><a class="fn-backref" href="#id6">OPH96</a></span></dt>
<dd><p>Timo Ojala, Matti Pietikäinen, and David Harwood. A comparative study of texture measures with classification based on featured distributions. <em>Pattern recognition</em>, 29(1):51–59, 1996. <a class="reference external" href="https://doi.org/10.1016/0031-3203(95)00067-4">doi:10.1016/0031-3203(95)00067-4</a>.</p>
</dd>
<dt class="label" id="id30"><span class="brackets"><a class="fn-backref" href="#id7">OPM02</a></span></dt>
<dd><p>Timo Ojala, Matti Pietikäinen, and Topi Maenpaa. Multiresolution gray-scale and rotation invariant texture classification with local binary patterns. <em>IEEE Transactions on pattern analysis and machine intelligence</em>, 24(7):971–987, 2002. <a class="reference external" href="https://doi.org/10.1109/tpami.2002.1017623">doi:10.1109/tpami.2002.1017623</a>.</p>
</dd>
<dt class="label" id="id49"><span class="brackets">PD07</span><span class="fn-backref">(<a href="#id15">1</a>,<a href="#id19">2</a>)</span></dt>
<dd><p>Florent Perronnin and Christopher Dance. Fisher kernels on visual vocabularies for image categorization. In <em>2007 IEEE Conference on Computer Vision and Pattern Recognition</em>. IEEE, jun 2007. <a class="reference external" href="https://doi.org/10.1109/cvpr.2007.383266">doi:10.1109/cvpr.2007.383266</a>.</p>
</dd>
<dt class="label" id="id51"><span class="brackets"><a class="fn-backref" href="#id23">RRKB11</a></span></dt>
<dd><p>Ethan Rublee, Vincent Rabaud, Kurt Konolige, and Gary Bradski. ORB: an efficient alternative to SIFT or SURF. In <em>2011 International Conference on Computer Vision</em>. IEEE, nov 2011. <a class="reference external" href="https://doi.org/10.1109/iccv.2011.6126544">doi:10.1109/iccv.2011.6126544</a>.</p>
</dd>
</dl>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./contents/sec2"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="data-visualization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">前へ</p>
        <p class="prev-next-title"><span class="section-number">1. </span>データ可視化と次元圧縮</p>
      </div>
    </a>
    <a class="right-next"
       href="deep-learning.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">次へ</p>
        <p class="prev-next-title"><span class="section-number">3. </span>深層学習による物体認識</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> 目次
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">2.1. データセットの前処理</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2.1.1. 分類用のデータ加工</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#svm">2.1.2. 実験: SVMによる分類</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">2.2. 主成分分析による次元圧縮</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">2.2.1. 輝度によるヒストグラム化</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#local-binary-pattern-lbp">2.3. Local Binary Pattern (LBP)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uniform-lbp">2.3.1. Uniform LBP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#histogram-of-oriented-gradient-hog">2.4. Histogram of Oriented Gradient (HOG)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bag-of-visual-words">2.5. Bag of Visual Words</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scale-invariant-feature-transform-sift">2.5.1. Scale-Invariant Feature Transform (SIFT)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">特徴点の抽出</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">特徴量の計算</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">2.5.2. 特徴量のクラスタリング</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gauss">2.5.3. Gauss混合モデルを用いた改良</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fisher">2.5.4. Fisherベクトルの利用</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Fisherベクトルの導出</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Fisherベクトルの意味</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Fisherベクトルを用いた画像分類</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">2.6. 手法の比較</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">2.7. 練習問題</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">2.8. 参考文献</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
著者 Tatsuya Yatagawa
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright CC BY-NC-SA 4.0, 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>